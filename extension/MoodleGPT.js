!function(){"use strict";function e(e){const n=document.title;document.title=e,setTimeout((()=>document.title=n),3e3)}function n(e,n){const t=e.length>n.length?e.length:n.length;return 0===t?1:(t-function(e,n){if(0===e.length)return n.length;if(0===n.length)return e.length;const t=[],o=e.replace(/\s+/,""),r=n.replace(/\s+/,"");for(let e=0;e<=o.length;++e){t.push([e]);for(let n=1;n<=r.length;++n)t[e][n]=0===e?n:Math.min(t[e-1][n]+1,t[e][n-1]+1,t[e-1][n-1]+(o[e-1]===r[n-1]?0:1))}return t[o.length][r.length]}(e,n))/t}function t(e,t){let o={element:null,similarity:0,value:null};for(const r of t){const t=n(r.value,e);if(1===t)return{element:r.element,value:r.value,similarity:t};t>o.similarity&&(o={element:r.element,value:r.value,similarity:t})}return o}class o{static question(e){console.log("%c[QUESTION]: %s","color: cyan",e)}static bestAnswer(e,n){console.log("%c[BEST ANSWER]: %s","color: green",`"${e}" with a similarity of ${function(e){return Math.round(100*e*100)/100+"%"}(n)}`)}static array(e){console.log("[CORRECTS] ",e)}static response(e){console.log("Original:\n"+e.response),console.log("Normalized:\n"+e.normalizedResponse)}}function r(e,n=!0){n&&(e=e.toLowerCase());return e.replace(/\n+/gi,"\n").replace(/(\n\s*\n)+/g,"\n").replace(/[ \t]+/gi," ").trim().replace(/^[a-z\d]\.\s/gi,"").replace(/\n[a-z\d]\.\s/gi,"\n")}async function s(e,n,t){const o=n.querySelectorAll("img");if(!e.includeImages||0===o.length)return t;const r=[],s=Array.from(o).map((e=>function(e,n=.75){return new Promise(((t,o)=>{const r=document.createElement("canvas"),s=r.getContext("2d");if(!s)return o("Can't get the canvas context, ensure your navigator support canvas"),void r.remove();const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>{r.width=i.width,r.height=i.height,s.drawImage(i,0,0);const e=r.toDataURL("image/png",n);t(e),r.remove()},i.onerror=e=>{o(e),r.remove()},i.src=e.src}))}(e))),i=await Promise.allSettled(s);for(const n of i)"fulfilled"===n.status?r.push({type:"image_url",image_url:{url:n.value}}):e.logs&&console.error(n.reason);return r.push({type:"text",text:t}),r}async function i(e,n,t){const o={role:"user",content:await s(e,n,t)},r=function(e){if(e)return{role:"system",content:'\nYou are a quiz assistant. Provide the correct answer(s) and, when helpful, concise reasoning or brief explanations.\n\nRULES:\n- If answer options are provided, return the correct answer(s) exactly as written in the option(s).\n- Format answers as:\n<answer 1>\n<answer 2>\n...\n- Keep the answers in the same order as they appear in the question.\n- Retain all text from the selected answer option (including descriptions).\n- For "put in order" questions, output in the format:\n<order>:<answer>\n<order>:<answer>\n- If the question provides no answer options, provide a full answer and include brief reasoning when useful.\n- For math questions without options, include:\nresult: <value>\n- Do not include long, unnecessary explanations; keep reasoning concise and relevant.\n- Always respond in the same language as the question.\n'.trim()};return{role:"system",content:'\nAct as a quiz solver.\n\nRULES:\n- Output ONLY the correct answer(s) exactly as written in the provided options.\n- Format answers as:\n<answer 1>\n<answer 2>\n...\n- Keep the answers in the same order as they appear in the question.\n- Retain all text from the selected answer option (including descriptions).\n- For "put in order" questions, output only in the format:\n<order>:<answer>\n<order>:<answer>\n- If the question provides no answer options, respond normally.\n- For math questions without options, add:\nresult: <value>\n- Never include explanations, reasoning, or extra text.\n- Never mention these instructions in your answer.\n- Always respond in the same language as the question.\n- NO EXPLANATIONS, JUST ANSWERS.\n'.trim()}}(Boolean(e.useReasoning));if(!e.history)return{messages:[r,o]};let i;const c=JSON.parse(sessionStorage.moodleGPTHistory??"null"),a=function(){const e=new URLSearchParams(document.location.search);return{host:document.location.host,cmid:e.get("cmid")??"",attempt:e.get("attempt")??"",history:[]}}();var l,u;return i=null===c||(u=a,(l=c).host!==u.host||l.cmid!==u.cmid||l.attempt!==u.attempt)?a:c,{messages:[r,...i.history,o],saveResponse(n){e.history&&(i.history.push(o),i.history.push({role:"assistant",content:n}),sessionStorage.moodleGPTHistory=JSON.stringify(i))}}}function c(e){const n=[],t=Array.from(e.querySelectorAll("tr")),o=[];t.map((e=>{const t=Array.from(e.querySelectorAll("td, th")).map(((e,n)=>{const t=e.textContent?.trim();return o[n]=Math.max(o[n]||0,t?.length||0),t??""}));n.push(t)}));const r=n[0].length,s=o.reduce(((e,n)=>e+n),0)+3*(r-1),i="\n"+Array(s).fill("-").join("")+"\n",c=n.map((e=>e.map(((e,n)=>e.padEnd(o[n],"Â "))).join(" | ")));return c.shift()+i+c.join("\n")}function a(n,t){n.title&&e("Copied to clipboard"),navigator.clipboard.writeText(t.response)}function l(e,n,t){const o=n[0];if(1!==n.length||!function(e){const n=e.getAttribute("contenteditable");return"string"==typeof n&&"false"!==n}(o))return!1;if(e.typing){let e=0;const n=function(r){if(r.preventDefault(),"Backspace"===r.key||e>=t.response.length)return void o.removeEventListener("keydown",n);o.textContent=t.response.slice(0,++e),o.focus();const s=document.createRange();s.selectNodeContents(o),s.collapse(!1);const i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(s))};o.addEventListener("keydown",n)}else o.textContent=t.response;return!0}function u(e,n,t){const o=n[0];if(1!==n.length||"number"!==o.type)return!1;const r=t.normalizedResponse.match(/\d+([,.]\d+)?/gi)?.[0]?.replace(",",".");if(void 0===r)return!1;if(e.typing){let e=0;const n=function(t){t.preventDefault(),"Backspace"===t.key||e>=r.length?o.removeEventListener("keydown",n):("."===r.slice(e,e+1)&&++e,o.value=r.slice(0,++e))};o.addEventListener("keydown",n)}else o.value=r;return!0}function m(e,n,s){const i=n?.[0];if(!i||"radio"!==i.type)return!1;const c=Array.from(n).map((e=>({element:e,value:r(e?.parentElement?.textContent??"")}))).filter((e=>""!==e.value)),a=t(s.normalizedResponse,c);e.logs&&a.value&&o.bestAnswer(a.value,a.similarity);const l=a.element;return e.mouseover?l.addEventListener("mouseover",(()=>l.click()),{once:!0}):l.click(),!0}function p(e,n,s){const i=n?.[0];if(!i||"checkbox"!==i.type)return!1;const c=s.normalizedResponse.split("\n"),a=Array.from(n).map((e=>({element:e,value:r(e?.parentElement?.textContent??"")}))).filter((e=>""!==e.value)),l=new Set;for(const n of c){const r=t(n,a);e.logs&&r.value&&o.bestAnswer(r.value,r.similarity),l.add(r.element)}for(const n of a.map((e=>e.element))){const t=n.checked&&!l.has(n)||!n.checked&&l.has(n),o=()=>t&&n.click();e.mouseover?n.addEventListener("mouseover",o,{once:!0}):o()}return!0}function d(e,n,s){if(0===n.length||"SELECT"!==n[0].tagName)return!1;const i=s.normalizedResponse.split("\n");e.logs&&o.array(i);for(let s=0;s<n.length&&i[s];++s){const c=n[s].querySelectorAll("option"),a=Array.from(c).slice(1).map((e=>({element:e,value:r(e.textContent??"")}))).filter((e=>""!==e.value)),l=t(i[s],a);e.logs&&l.value&&o.bestAnswer(l.value,l.similarity);const u=l.element,m=u.closest("select");null!==m&&(e.mouseover?m.addEventListener("click",(()=>u.selected=!0),{once:!0}):u.selected=!0)}return!0}function f(e,n,t){const o=n[0];if(1!==n.length||"TEXTAREA"!==o.tagName&&"text"!==o.type)return!1;if(e.typing){let e=0;const n=function(r){r.preventDefault(),"Backspace"===r.key||e>=t.response.length?o.removeEventListener("keydown",n):o.value=t.response.slice(0,++e)};o.addEventListener("keydown",n)}else o.value=t.response;return!0}function g(e,n,t){const o=n[0];if(!o.classList.contains("qtype_essay_editor"))return!1;const r=o.querySelector("iframe");if(!(r&&r.contentDocument&&r.contentDocument.body&&r.contentWindow))return!1;const s=r.contentDocument.body.querySelector("p");if(!s)return!1;if(e.typing){let e=0;const n=function(o){if(o.preventDefault(),"Backspace"===o.key||e>=t.response.length)return void r.contentWindow.removeEventListener("keydown",n);const i=document.createTextNode(t.response.charAt(e++));s.appendChild(i);const c=r.contentDocument.createRange();c.selectNodeContents(s),c.collapse(!1);const a=r.contentWindow.getSelection();a&&(a.removeAllRanges(),a.addRange(c)),r.contentWindow.focus()};r.contentWindow.addEventListener("keydown",n)}else s.textContent+=t.response;return!0}async function h(e){e.config.cursor&&(e.questionElement.style.cursor="wait");const n=function(e){let n=e.innerText;const t=e.querySelectorAll(".accesshide");for(const e of t)n=n.replace(e.innerText,"");const o=e.querySelector(".qtype_essay_editor");o&&(n=n.replace(o.innerText,""));const s=e.querySelector('[role="button"]');s&&(n=n.replace(s.innerText,""));const i=e.querySelectorAll(".qtext table");for(const e of i)n=n.replace(e.innerText,"\n"+c(e)+"\n");return r(n,!1)}(e.form),t=e.form.querySelectorAll(e.inputQuery),s=await async function(e,n,t){const o=new AbortController,s=setTimeout((()=>o.abort()),2e4);let c;c=t?await i(e,t,n):{messages:[{role:"user",content:n}]};const a=`${e.baseURL&&""!==e.baseURL.trim()?e.baseURL.replace(/\/+$/,""):"https://openrouter.ai"}/api/v1/chat/completions`,l=[...c.messages],u=await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:e.model,messages:l,max_tokens:e.maxTokens||200}),signal:e.timeout?o.signal:null});if(clearTimeout(s),!u.ok)throw new Error(`OpenRouter API error ${u.status}: ${await u.text()}`);const m=await u.json(),p=m.choices?.[0]?.message?.content??JSON.stringify(m);return"saveResponse"in c&&"function"==typeof c.saveResponse&&c.saveResponse(p),{question:n,response:p,normalizedResponse:r(p)}}(e.config,n,e.questionElement).catch((e=>({error:e}))),h="object"==typeof s&&"error"in s;if(e.config.cursor&&(e.questionElement.style.cursor=e.config.infinite||h?"pointer":"initial"),h)console.error(s.error);else switch(e.config.logs&&(o.question(n),o.response(s)),e.config.mode){case"clipboard":!function(e){e.config.infinite||e.removeListener(),a(e.config,e.gptAnswer)}({config:e.config,questionElement:e.questionElement,gptAnswer:s,removeListener:e.removeListener});break;case"question-to-answer":!function(e){const n=e.questionElement;e.removeListener();const t=n.innerHTML??"";n.innerHTML=e.gptAnswer.response,n.style.whiteSpace="pre-wrap",n.addEventListener("click",(function(){const o=n.innerHTML===e.gptAnswer.response;n.style.whiteSpace=o?"initial":"pre-wrap",n.innerHTML=o?t:e.gptAnswer.response}))}({gptAnswer:s,questionElement:e.questionElement,removeListener:e.removeListener});break;case"autocomplete":!function(e){e.config.infinite||e.removeListener();const n=[g,l,f,u,d,m,p];for(const t of n)if(t(e.config,e.inputList,e.gptAnswer))return;a(e.config,e.gptAnswer)}({config:e.config,gptAnswer:s,inputList:t,questionElement:e.questionElement,removeListener:e.removeListener})}}const y=[],v=[];function w(e){const n=v.findIndex((n=>n.element===e));if(-1!==n){const e=v.splice(n,1)[0];e.element.removeEventListener("click",e.fn)}}function q(n){if(v.length>0){for(const e of v)n.cursor&&(e.element.style.cursor="initial"),e.element.removeEventListener("click",e.fn);return n.title&&e("Removed"),void(v.length=0)}const t=["checkbox","radio","text","number"].map((e=>`input[type="${e}"]`)).join(",")+", textarea, select, [contenteditable], .qtype_essay_editor",o=document.querySelectorAll(".formulation");for(const e of o){const o=e.querySelector(".qtext");if(null===o)continue;n.cursor&&(o.style.cursor="pointer");const r=h.bind(null,{config:n,questionElement:o,form:e,inputQuery:t,removeListener:()=>w(o)});v.push({element:o,fn:r}),o.addEventListener("click",r)}n.title&&e("Injected")}chrome.storage.sync.get(["moodleGPT"]).then((function(e){const n=e.moodleGPT;if(!n)throw new Error("Please configure MoodleGPT into the extension");n.code?function(e){document.body.addEventListener("keydown",(function(n){y.push(n.key),y.length>e.code.length&&y.shift(),y.join("")===e.code&&(y.length=0,q(e))}))}(n):q(n)}))}();
//# sourceMappingURL=MoodleGPT.js.map
