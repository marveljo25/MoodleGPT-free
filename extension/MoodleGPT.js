!function(){"use strict";function e(e){const t=document.title;document.title=e,setTimeout((()=>document.title=t),3e3)}function t(e,t){const n=e.length>t.length?e.length:t.length;return 0===n?1:(n-function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;const n=[],o=e.replace(/\s+/,""),r=t.replace(/\s+/,"");for(let e=0;e<=o.length;++e){n.push([e]);for(let t=1;t<=r.length;++t)n[e][t]=0===e?t:Math.min(n[e-1][t]+1,n[e][t-1]+1,n[e-1][t-1]+(o[e-1]===r[t-1]?0:1))}return n[o.length][r.length]}(e,t))/n}function n(e,n){let o={element:null,similarity:0,value:null};for(const r of n){const n=t(r.value,e);if(1===n)return{element:r.element,value:r.value,similarity:n};n>o.similarity&&(o={element:r.element,value:r.value,similarity:n})}return o}class o{static question(e){console.log("%c[QUESTION]: %s","color: cyan",e)}static bestAnswer(e,t){console.log("%c[BEST ANSWER]: %s","color: green",`"${e}" with a similarity of ${function(e){return Math.round(100*e*100)/100+"%"}(t)}`)}static array(e){console.log("[CORRECTS] ",e)}static response(e){console.log("Original:\n"+e.response),console.log("Normalized:\n"+e.normalizedResponse)}}function r(e,t=!0){t&&(e=e.toLowerCase());return e.replace(/\n+/gi,"\n").replace(/(\n\s*\n)+/g,"\n").replace(/[ \t]+/gi," ").trim().replace(/^[a-z\d]\.\s/gi,"").replace(/\n[a-z\d]\.\s/gi,"\n")}const s={role:"system",content:"\nAct as a quiz solver for the best notation with the following rules:\n- If no answer(s) are given, answer the statement as usual without following the other rules, providing the most detailed, complete and precise explanation. \n- But for the calculation provide this format 'result: <result of the equation>'\n- For 'put in order' questions, maintain the answer in the order as presented in the question but assocy the correct order to it by usin this format '<order>:<answer 1>\n<order>:<answer 2>', ignore other rules.\n- Always reply in the format: '<answer 1>\n<answer 2>\n...'.\n- Retain only the correct answer(s).\n- Maintain the same order for the answers as in the text.\n- Retain all text from the answer with its description, content or definition.\n- Only provide answers that exactly match the given answer in the text.\n- The question always has the correct answer(s), so you should always provide an answer.\n- Always respond in the same language as the user's question.\n".trim()};async function i(e,t,n){const o=t.querySelectorAll("img");if(!e.includeImages||0===o.length)return n;const r=[],s=Array.from(o).map((e=>function(e,t=.75){return new Promise(((n,o)=>{const r=document.createElement("canvas"),s=r.getContext("2d");if(!s)return o("Can't get the canvas context, ensure your navigator support canvas"),void r.remove();const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>{r.width=i.width,r.height=i.height,s.drawImage(i,0,0);const e=r.toDataURL("image/png",t);n(e),r.remove()},i.onerror=e=>{o(e),r.remove()},i.src=e.src}))}(e))),i=await Promise.allSettled(s);for(const t of i)"fulfilled"===t.status?r.push({type:"image_url",image_url:{url:t.value}}):e.logs&&console.error(t.reason);return r.push({type:"text",text:n}),r}async function c(e,t,n){const o={role:"user",content:await i(e,t,n)};if(!e.history)return{messages:[s,o]};let r;const c=JSON.parse(sessionStorage.moodleGPTHistory??"null"),a=function(){const e=new URLSearchParams(document.location.search);return{host:document.location.host,cmid:e.get("cmid")??"",attempt:e.get("attempt")??"",history:[]}}();var l,u;return r=null===c||(u=a,(l=c).host!==u.host||l.cmid!==u.cmid||l.attempt!==u.attempt)?a:c,{messages:[s,...r.history,o],saveResponse(t){e.history&&(r.history.push(o),r.history.push({role:"assistant",content:t}),sessionStorage.moodleGPTHistory=JSON.stringify(r))}}}function a(e){const t=[],n=Array.from(e.querySelectorAll("tr")),o=[];n.map((e=>{const n=Array.from(e.querySelectorAll("td, th")).map(((e,t)=>{const n=e.textContent?.trim();return o[t]=Math.max(o[t]||0,n?.length||0),n??""}));t.push(n)}));const r=t[0].length,s=o.reduce(((e,t)=>e+t),0)+3*(r-1),i="\n"+Array(s).fill("-").join("")+"\n",c=t.map((e=>e.map(((e,t)=>e.padEnd(o[t],"Â "))).join(" | ")));return c.shift()+i+c.join("\n")}function l(t,n){t.title&&e("Copied to clipboard"),navigator.clipboard.writeText(n.response)}function u(e,t,n){const o=t[0];if(1!==t.length||!function(e){const t=e.getAttribute("contenteditable");return"string"==typeof t&&"false"!==t}(o))return!1;if(e.typing){let e=0;const t=function(r){if(r.preventDefault(),"Backspace"===r.key||e>=n.response.length)return void o.removeEventListener("keydown",t);o.textContent=n.response.slice(0,++e),o.focus();const s=document.createRange();s.selectNodeContents(o),s.collapse(!1);const i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(s))};o.addEventListener("keydown",t)}else o.textContent=n.response;return!0}function m(e,t,n){const o=t[0];if(1!==t.length||"number"!==o.type)return!1;const r=n.normalizedResponse.match(/\d+([,.]\d+)?/gi)?.[0]?.replace(",",".");if(void 0===r)return!1;if(e.typing){let e=0;const t=function(n){n.preventDefault(),"Backspace"===n.key||e>=r.length?o.removeEventListener("keydown",t):("."===r.slice(e,e+1)&&++e,o.value=r.slice(0,++e))};o.addEventListener("keydown",t)}else o.value=r;return!0}function f(e,t,s){const i=t?.[0];if(!i||"radio"!==i.type)return!1;const c=Array.from(t).map((e=>({element:e,value:r(e?.parentElement?.textContent??"")}))).filter((e=>""!==e.value)),a=n(s.normalizedResponse,c);e.logs&&a.value&&o.bestAnswer(a.value,a.similarity);const l=a.element;return e.mouseover?l.addEventListener("mouseover",(()=>l.click()),{once:!0}):l.click(),!0}function p(e,t,s){const i=t?.[0];if(!i||"checkbox"!==i.type)return!1;const c=s.normalizedResponse.split("\n"),a=Array.from(t).map((e=>({element:e,value:r(e?.parentElement?.textContent??"")}))).filter((e=>""!==e.value)),l=new Set;for(const t of c){const r=n(t,a);e.logs&&r.value&&o.bestAnswer(r.value,r.similarity),l.add(r.element)}for(const t of a.map((e=>e.element))){const n=t.checked&&!l.has(t)||!t.checked&&l.has(t),o=()=>n&&t.click();e.mouseover?t.addEventListener("mouseover",o,{once:!0}):o()}return!0}function d(e,t,s){if(0===t.length||"SELECT"!==t[0].tagName)return!1;const i=s.normalizedResponse.split("\n");e.logs&&o.array(i);for(let s=0;s<t.length&&i[s];++s){const c=t[s].querySelectorAll("option"),a=Array.from(c).slice(1).map((e=>({element:e,value:r(e.textContent??"")}))).filter((e=>""!==e.value)),l=n(i[s],a);e.logs&&l.value&&o.bestAnswer(l.value,l.similarity);const u=l.element,m=u.closest("select");null!==m&&(e.mouseover?m.addEventListener("click",(()=>u.selected=!0),{once:!0}):u.selected=!0)}return!0}function g(e,t,n){const o=t[0];if(1!==t.length||"TEXTAREA"!==o.tagName&&"text"!==o.type)return!1;if(e.typing){let e=0;const t=function(r){r.preventDefault(),"Backspace"===r.key||e>=n.response.length?o.removeEventListener("keydown",t):o.value=n.response.slice(0,++e)};o.addEventListener("keydown",t)}else o.value=n.response;return!0}function h(e,t,n){const o=t[0];if(!o.classList.contains("qtype_essay_editor"))return!1;const r=o.querySelector("iframe");if(!(r&&r.contentDocument&&r.contentDocument.body&&r.contentWindow))return!1;const s=r.contentDocument.body.querySelector("p");if(!s)return!1;if(e.typing){let e=0;const t=function(o){if(o.preventDefault(),"Backspace"===o.key||e>=n.response.length)return void r.contentWindow.removeEventListener("keydown",t);const i=document.createTextNode(n.response.charAt(e++));s.appendChild(i);const c=r.contentDocument.createRange();c.selectNodeContents(s),c.collapse(!1);const a=r.contentWindow.getSelection();a&&(a.removeAllRanges(),a.addRange(c)),r.contentWindow.focus()};r.contentWindow.addEventListener("keydown",t)}else s.textContent+=n.response;return!0}async function y(e){e.config.cursor&&(e.questionElement.style.cursor="wait");const t=function(e){let t=e.innerText;const n=e.querySelectorAll(".accesshide");for(const e of n)t=t.replace(e.innerText,"");const o=e.querySelector(".qtype_essay_editor");o&&(t=t.replace(o.innerText,""));const s=e.querySelector('[role="button"]');s&&(t=t.replace(s.innerText,""));const i=e.querySelectorAll(".qtext table");for(const e of i)t=t.replace(e.innerText,"\n"+a(e)+"\n");return r(t,!1)}(e.form),n=e.form.querySelectorAll(e.inputQuery),s=await async function(e,t,n){const o=new AbortController,s=setTimeout((()=>o.abort()),2e4),i=await c(e,t,n),a="https://api-inference.huggingface.co/models/MiaoshouAI/Florence-2-large-PromptGen-v2.0";let l;if("string"==typeof i.messages[i.messages.length-1].content){const t=i.messages.map((e=>"string"==typeof e.content?`${e.role}: ${e.content}`:JSON.stringify(e.content))).join("\n");l=await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:t,parameters:{max_new_tokens:e.maxTokens||200}}),signal:e.timeout?o.signal:null})}else{const t=new FormData;for(const e of i.messages[i.messages.length-1].content)if("image_url"===e.type){const n=e.image_url.url.split(",")[1],o=Uint8Array.from(atob(n),(e=>e.charCodeAt(0)));t.append("image",new Blob([o]))}else"text"===e.type&&t.append("text",e.text);l=await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`},body:t,signal:e.timeout?o.signal:null})}if(clearTimeout(s),!l.ok)throw new Error(`HF API error ${l.status}: ${await l.text()}`);const u=await l.json(),m=Array.isArray(u)&&u[0]?.generated_text?u[0].generated_text:JSON.stringify(u);return"function"==typeof i.saveResponse&&i.saveResponse(m),{question:n,response:m,normalizedResponse:r(m)}}(e.config,e.questionElement,t).catch((e=>({error:e}))),i="object"==typeof s&&"error"in s;if(e.config.cursor&&(e.questionElement.style.cursor=e.config.infinite||i?"pointer":"initial"),i)console.error(s.error);else switch(e.config.logs&&(o.question(t),o.response(s)),e.config.mode){case"clipboard":!function(e){e.config.infinite||e.removeListener(),l(e.config,e.gptAnswer)}({config:e.config,questionElement:e.questionElement,gptAnswer:s,removeListener:e.removeListener});break;case"question-to-answer":!function(e){const t=e.questionElement;e.removeListener();const n=t.innerHTML??"";t.innerHTML=e.gptAnswer.response,t.style.whiteSpace="pre-wrap",t.addEventListener("click",(function(){const o=t.innerHTML===e.gptAnswer.response;t.style.whiteSpace=o?"initial":"pre-wrap",t.innerHTML=o?n:e.gptAnswer.response}))}({gptAnswer:s,questionElement:e.questionElement,removeListener:e.removeListener});break;case"autocomplete":!function(e){e.config.infinite||e.removeListener();const t=[h,u,g,m,d,f,p];for(const n of t)if(n(e.config,e.inputList,e.gptAnswer))return;l(e.config,e.gptAnswer)}({config:e.config,gptAnswer:s,inputList:n,questionElement:e.questionElement,removeListener:e.removeListener})}}const v=[],w=[];function A(e){const t=w.findIndex((t=>t.element===e));if(-1!==t){const e=w.splice(t,1)[0];e.element.removeEventListener("click",e.fn)}}function x(t){if(w.length>0){for(const e of w)t.cursor&&(e.element.style.cursor="initial"),e.element.removeEventListener("click",e.fn);return t.title&&e("Removed"),void(w.length=0)}const n=["checkbox","radio","text","number"].map((e=>`input[type="${e}"]`)).join(",")+", textarea, select, [contenteditable], .qtype_essay_editor",o=document.querySelectorAll(".formulation");for(const e of o){const o=e.querySelector(".qtext");if(null===o)continue;t.cursor&&(o.style.cursor="pointer");const r=y.bind(null,{config:t,questionElement:o,form:e,inputQuery:n,removeListener:()=>A(o)});w.push({element:o,fn:r}),o.addEventListener("click",r)}t.title&&e("Injected")}chrome.storage.sync.get(["moodleGPT"]).then((function(e){const t=e.moodleGPT;if(!t)throw new Error("Please configure MoodleGPT into the extension");t.code?function(e){document.body.addEventListener("keydown",(function(t){v.push(t.key),v.length>e.code.length&&v.shift(),v.join("")===e.code&&(v.length=0,x(e))}))}(t):x(t)}))}();
//# sourceMappingURL=MoodleGPT.js.map
